name: Terraform Deploy

on:
  push:
    branches:
      - dev
      - staging
      - main

jobs:
  terraform:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Set Environment Variables
        run: |
          if [ "${GITHUB_REF_NAME}" == "dev" ]; then
            echo "WORKSPACE=dev" >> $GITHUB_ENV
            echo "TFVARS=env/dev.tfvars" >> $GITHUB_ENV
          elif [ "${GITHUB_REF_NAME}" == "staging" ]; then
            echo "WORKSPACE=staging" >> $GITHUB_ENV
            echo "TFVARS=env/staging.tfvars" >> $GITHUB_ENV
          elif [ "${GITHUB_REF_NAME}" == "main" ]; then
            echo "WORKSPACE=prod" >> $GITHUB_ENV
            echo "TFVARS=env/prod.tfvars" >> $GITHUB_ENV
          fi

      - name: Terraform Init
        run: terraform init -reconfigure

      - name: Select or Create Workspace
        run: |
          terraform workspace list
          if terraform workspace list | grep -q "${WORKSPACE}"; then
            echo "Selecting workspace ${WORKSPACE}"
            terraform workspace select "${WORKSPACE}"
          else
            echo "Creating workspace ${WORKSPACE}"
            terraform workspace new "${WORKSPACE}"
            terraform workspace select "${WORKSPACE}"
          fi

      - name: Terraform Plan
        run: terraform plan -var-file="${TFVARS}"

      - name: Terraform Apply
        run: terraform apply -auto-approve -var-file="${TFVARS}"
